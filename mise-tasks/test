#!/usr/bin/env bash
#MISE description="Run backend plugin tests - test plugin linking and basic functionality"
set -euo pipefail

# Link the plugin for testing
mise plugin link --force rv .

# Clear cache to ensure fresh testing
mise cache clear

echo "Testing mise-rv backend plugin..."
echo "=================================="

# Test tool name - we only support "ruby"
TEST_TOOL="ruby"
TEST_VERSION="3.3.9"

# Test 1: Version listing
echo ""
echo "Test 1: Version listing"
echo "-----------------------"
if mise ls-remote rv:${TEST_TOOL} | grep -q "${TEST_VERSION}"; then
    echo "✓ Version listing works (found ${TEST_VERSION})"
else
    echo "✗ Version listing failed - ${TEST_VERSION} not found"
    exit 1
fi

# Test 2: Installation
echo ""
echo "Test 2: Installation"
echo "--------------------"
if mise install rv:${TEST_TOOL}@${TEST_VERSION}; then
    echo "✓ Installation works"
else
    echo "✗ Installation failed"
    exit 1
fi

# Test 3: Ruby execution
echo ""
echo "Test 3: Ruby execution"
echo "----------------------"
if mise exec rv:${TEST_TOOL}@${TEST_VERSION} -- ruby --version | grep -q "ruby ${TEST_VERSION}"; then
    echo "✓ Ruby execution works"
else
    echo "✗ Ruby execution failed"
    exit 1
fi

# Test 4: Gem environment
echo ""
echo "Test 4: Gem environment"
echo "-----------------------"
if mise exec rv:${TEST_TOOL}@${TEST_VERSION} -- gem env | grep -q "GEM PATHS"; then
    echo "✓ Gem environment configured"
else
    echo "✗ Gem environment not configured properly"
    exit 1
fi

# Test 5: Gem installation
echo ""
echo "Test 5: Gem installation"
echo "------------------------"
if mise exec rv:${TEST_TOOL}@${TEST_VERSION} -- gem install json --no-document 2>&1 | grep -q "Successfully installed"; then
    echo "✓ Gem installation works"
else
    echo "✗ Gem installation failed"
    exit 1
fi

echo ""
echo "=================================="
echo "✓ All tests passed!"
